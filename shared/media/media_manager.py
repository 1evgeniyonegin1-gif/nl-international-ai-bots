"""
MediaManager –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–¥–∏–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º –±–æ—Ç–æ–≤ NL International.

–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç:
- –°—Ç–∏–∫–µ—Ä—ã –ø–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é
- –ì–∏—Ñ–∫–∏ –ø–æ —Ç–∏–ø—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –≠–º–æ–¥–∑–∏-–ø–∞–∫–∏
- –§–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ unified_products/
"""
from typing import Optional, List, Dict, Any
from pathlib import Path
import random
from loguru import logger


class MediaManager:
    """
    –ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ–¥–∏–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.

    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    1. –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∏–∫–µ—Ä –ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: get_sticker_for_mood("happy")
    2. –ü–æ–ª—É—á–∏—Ç—å –≥–∏—Ñ–∫—É –¥–ª—è –ø–æ—Å—Ç–∞: get_gif_for_post_type("celebration")
    3. –ü–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–∞: get_product_photo("collagen")
    """

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –°–¢–ò–ö–ï–†–´ –ü–û –ù–ê–°–¢–†–û–ï–ù–ò–Æ
    # –§–æ—Ä–º–∞—Ç: file_id –∏–∑ Telegram (–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ @RawDataBot)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    STICKERS = {
        # –†–∞–¥–æ—Å—Ç–Ω—ã–µ, –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ
        "happy": [
            # TODO: –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ file_id —Å—Ç–∏–∫–µ—Ä–æ–≤
            # "CAACAgIAAxkBAAIBXmV...—Å—Ç–∏–∫–µ—Ä_—Ä–∞–¥–æ—Å—Ç—å_1",
            # "CAACAgIAAxkBAAIBX2V...—Å—Ç–∏–∫–µ—Ä_—Ä–∞–¥–æ—Å—Ç—å_2",
        ],
        "celebration": [
            # –°—Ç–∏–∫–µ—Ä—ã –¥–ª—è –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
        ],
        "excited": [
            # –≠–Ω–µ—Ä–≥–∏—á–Ω—ã–µ, –≤–∑—Ä—ã–≤–Ω—ã–µ —Å—Ç–∏–∫–µ—Ä—ã
        ],

        # –ü–æ–¥–¥–µ—Ä–∂–∫–∞, —ç–º–ø–∞—Ç–∏—è
        "support": [
            # –û–±–Ω–∏–º–∞—à–∫–∏, –ø–æ–¥–¥–µ—Ä–∂–∫–∞
        ],
        "thinking": [
            # –ó–∞–¥—É–º—á–∏–≤—ã–µ —Å—Ç–∏–∫–µ—Ä—ã
        ],

        # –ú–æ—Ç–∏–≤–∞—Ü–∏—è
        "motivation": [
            # –í–ø–µ—Ä—ë–¥! –¢—ã —Å–º–æ–∂–µ—à—å!
        ],
        "success": [
            # –ü–æ–±–µ–¥–∞, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ
        ],

        # –ü—Ä–æ–¥—É–∫—Ç—ã
        "product": [
            # –°—Ç–∏–∫–µ—Ä—ã —Å –∫–æ–∫—Ç–µ–π–ª—è–º–∏, –≤–∏—Ç–∞–º–∏–Ω–∞–º–∏
        ],

        # –ë–∏–∑–Ω–µ—Å
        "business": [
            # –î–µ–Ω—å–≥–∏, —Ä–æ—Å—Ç, –∫–æ–º–∞–Ω–¥–∞
        ],

        # –£—Å—Ç–∞–ª–æ—Å—Ç—å, —á–µ—Å—Ç–Ω–æ—Å—Ç—å
        "tired": [
            # –£—Å—Ç–∞–≤—à–∏–µ, –Ω–æ —á–µ—Å—Ç–Ω—ã–µ —Å—Ç–∏–∫–µ—Ä—ã
        ]
    }

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –ì–ò–§–ö–ò –ü–û –¢–ò–ü–£ –ö–û–ù–¢–ï–ù–¢–ê
    # –§–æ—Ä–º–∞—Ç: URL –≥–∏—Ñ–∫–∏ –∏–ª–∏ file_id
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    GIFS = {
        # –ü—Ä–∏–º–µ—Ä—ã –∂–µ–ª–∞–µ–º–æ–≥–æ —Å—Ç–∏–ª—è (—Ä—ã—Ü–∞—Ä—å/–∞—Å—Ç—Ä–æ–Ω–∞–≤—Ç AI-–∞—Ä—Ç):
        # - –†–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω—ã–π —Ä—ã—Ü–∞—Ä—å –Ω–∞ —Ñ–ª–∞–º–∏–Ω–≥–æ –≤ –±–∞—Å—Å–µ–π–Ω–µ
        # - –†—ã—Ü–∞—Ä—å —Å—ë—Ä—Ñ–∏—Ç –Ω–∞ –≤–æ–ª–Ω–µ
        # - –†—ã—Ü–∞—Ä—å –Ω–∞ –≥–∏–≥–∞–Ω—Ç—Å–∫–æ–º –∂—É–∫–µ –ø–æ–¥ –∑–≤—ë–∑–¥–∞–º–∏

        "celebration": [
            # –ì–∏—Ñ–∫–∏ –¥–ª—è –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
            # "https://media.giphy.com/...",
        ],
        "motivation": [
            # –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ –≥–∏—Ñ–∫–∏
        ],
        "product": [
            # –ì–∏—Ñ–∫–∏ –¥–ª—è –ø–æ—Å—Ç–æ–≤ –æ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö
        ],
        "business": [
            # –ì–∏—Ñ–∫–∏ –ø—Ä–æ –±–∏–∑–Ω–µ—Å –∏ —É—Å–ø–µ—Ö
        ],
        "success_story": [
            # –ì–∏—Ñ–∫–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–π —É—Å–ø–µ—Ö–∞
        ],
        "tips": [
            # –ì–∏—Ñ–∫–∏ –¥–ª—è —Å–æ–≤–µ—Ç–æ–≤
        ],
        "relaxed": [
            # –†–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω—ã–µ, —á–∏–ª–ª–æ–≤—ã–µ –≥–∏—Ñ–∫–∏
        ],
        "energy": [
            # –≠–Ω–µ—Ä–≥–∏—á–Ω—ã–µ, –¥—Ä–∞–π–≤–æ–≤—ã–µ –≥–∏—Ñ–∫–∏
        ]
    }

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –≠–ú–û–î–ó–ò –ü–ê–ö–ò (–¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    EMOJI_PACKS = {
        "expert": ["üìä", "üí°", "üß†", "üìå", "‚úÖ", "üìà", "üéØ", "‚ö°", "üìã", "üî¨"],
        "friend": ["‚ù§Ô∏è", "ü§ó", "üòä", "‚ú®", "üí´", "üôå", "üí™", "üî•", "ü•∞", "üíï"],
        "rebel": ["üî•", "üí•", "‚ö°", "üò§", "üé≠", "üëä", "üöÄ", "üí£", "ü§ò", "üòà"],
        "philosopher": ["ü§î", "üí≠", "üåå", "üîÆ", "üìñ", "üßò", "‚òØÔ∏è", "üåü", "ü™ê", "üåô"],
        "crazy": ["ü§™", "üò±", "üéâ", "üéä", "üåà", "ü¶Ñ", "üçï", "üöÅ", "üé™", "ü¶ã"],
        "tired": ["üòÆ‚Äçüí®", "üòî", "üí§", "ü•Ä", "üåßÔ∏è", "üçÇ", "‚òï", "üõå", "üò¥", "ü´†"],

        # –ü–æ —ç–º–æ—Ü–∏—è–º
        "joy": ["üòÑ", "üéâ", "‚ú®", "üåü", "üí´", "ü•≥", "üéä", "üíõ"],
        "sadness": ["üòî", "üíî", "ü•∫", "üò¢", "üåßÔ∏è", "üíô"],
        "anger": ["üò§", "üí¢", "üî•", "üí•", "‚ö°", "üëä"],
        "love": ["‚ù§Ô∏è", "üíï", "ü•∞", "üíó", "üíñ", "üíù", "üòç"],
        "surprise": ["üò±", "ü§Ø", "üò≤", "üòÆ", "üôÄ", "‚ùó"],
        "calm": ["üßò", "‚òÆÔ∏è", "üåø", "üçÉ", "üíÜ", "üå∏"],
        "excitement": ["üöÄ", "üî•", "‚ö°", "üí•", "üéØ", "üèÜ"],
    }

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –ü–£–¢–ò –ö –†–ï–°–£–†–°–ê–ú
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    def __init__(self, products_path: Optional[str] = None):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MediaManager.

        Args:
            products_path: –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ unified_products/ (—Ñ–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤)
        """
        self.products_path = Path(products_path) if products_path else None
        self._product_photos_cache: Dict[str, List[str]] = {}
        logger.info("MediaManager initialized")

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –°–¢–ò–ö–ï–†–´
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    def get_sticker_for_mood(self, mood: str) -> Optional[str]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç file_id —Å—Ç–∏–∫–µ—Ä–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è.

        Args:
            mood: –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (happy, support, motivation, etc.)

        Returns:
            str: file_id —Å—Ç–∏–∫–µ—Ä–∞ –∏–ª–∏ None
        """
        stickers = self.STICKERS.get(mood, [])
        if stickers:
            return random.choice(stickers)

        # Fallback –Ω–∞ –ø–æ—Ö–æ–∂–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
        mood_fallbacks = {
            "happy": "celebration",
            "celebration": "happy",
            "excited": "motivation",
            "support": "thinking",
        }
        fallback_mood = mood_fallbacks.get(mood)
        if fallback_mood:
            fallback_stickers = self.STICKERS.get(fallback_mood, [])
            if fallback_stickers:
                return random.choice(fallback_stickers)

        return None

    def get_random_sticker(self) -> Optional[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π —Å—Ç–∏–∫–µ—Ä –∏–∑ –ª—é–±–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
        all_stickers = []
        for stickers in self.STICKERS.values():
            all_stickers.extend(stickers)
        return random.choice(all_stickers) if all_stickers else None

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –ì–ò–§–ö–ò
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    def get_gif_for_post_type(self, post_type: str) -> Optional[str]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL/file_id –≥–∏—Ñ–∫–∏ –¥–ª—è —Ç–∏–ø–∞ –ø–æ—Å—Ç–∞.

        Args:
            post_type: –¢–∏–ø –ø–æ—Å—Ç–∞ (celebration, motivation, product, etc.)

        Returns:
            str: URL –∏–ª–∏ file_id –≥–∏—Ñ–∫–∏
        """
        gifs = self.GIFS.get(post_type, [])
        if gifs:
            return random.choice(gifs)

        # Fallback
        type_fallbacks = {
            "success_story": "celebration",
            "promo": "celebration",
            "news": "business",
            "tips": "motivation",
        }
        fallback_type = type_fallbacks.get(post_type)
        if fallback_type:
            fallback_gifs = self.GIFS.get(fallback_type, [])
            if fallback_gifs:
                return random.choice(fallback_gifs)

        return None

    def get_gif_for_mood(self, mood: str, intensity: str = "medium") -> Optional[str]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–∏—Ñ–∫—É –ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.

        Args:
            mood: –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
            intensity: –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å (light, medium, strong, extreme)

        Returns:
            str: URL –∏–ª–∏ file_id –≥–∏—Ñ–∫–∏
        """
        mood_to_type = {
            "joy": "celebration",
            "excitement": "energy",
            "calm": "relaxed",
            "sadness": "relaxed",
            "anger": "motivation",
            "love": "celebration",
            "anticipation": "energy",
        }
        gif_type = mood_to_type.get(mood, "motivation")
        return self.get_gif_for_post_type(gif_type)

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –≠–ú–û–î–ó–ò
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    def get_emojis_for_persona(self, persona: str, count: int = 5) -> List[str]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–±–æ—Ä —ç–º–æ–¥–∑–∏ –¥–ª—è –ø–µ—Ä—Å–æ–Ω—ã.

        Args:
            persona: –í–µ—Ä—Å–∏—è –ø–µ—Ä—Å–æ–Ω—ã
            count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–º–æ–¥–∑–∏

        Returns:
            List[str]: –°–ø–∏—Å–æ–∫ —ç–º–æ–¥–∑–∏
        """
        emojis = self.EMOJI_PACKS.get(persona, self.EMOJI_PACKS["friend"])
        return random.sample(emojis, min(count, len(emojis)))

    def get_emojis_for_mood(self, mood: str, count: int = 3) -> List[str]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è.

        Args:
            mood: –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
            count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–º–æ–¥–∑–∏

        Returns:
            List[str]: –°–ø–∏—Å–æ–∫ —ç–º–æ–¥–∑–∏
        """
        emojis = self.EMOJI_PACKS.get(mood, self.EMOJI_PACKS["joy"])
        return random.sample(emojis, min(count, len(emojis)))

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # –§–û–¢–û –ü–†–û–î–£–ö–¢–û–í
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    def get_product_photo(self, product_name: str) -> Optional[str]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ —Ñ–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–∞.

        Args:
            product_name: –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ (collagen, energy_diet, etc.)

        Returns:
            str: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–ª–∏ None
        """
        if not self.products_path or not self.products_path.exists():
            return None

        # –ò—â–µ–º –≤ –∫—ç—à–µ
        if product_name in self._product_photos_cache:
            photos = self._product_photos_cache[product_name]
            if photos:
                return random.choice(photos)
            return None

        # –ò—â–µ–º —Ñ–∞–π–ª—ã
        product_name_lower = product_name.lower().replace(" ", "_")
        patterns = [
            f"*{product_name_lower}*",
            f"*{product_name.lower()}*",
        ]

        photos = []
        for pattern in patterns:
            for ext in ["*.jpg", "*.jpeg", "*.png", "*.webp"]:
                full_pattern = f"**/{pattern}{ext}"
                photos.extend(self.products_path.glob(full_pattern))

        # –ö—ç—à–∏—Ä—É–µ–º
        photo_paths = [str(p) for p in photos]
        self._product_photos_cache[product_name] = photo_paths

        if photo_paths:
            return random.choice(photo_paths)
        return None

    def list_available_products(self) -> List[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å —Ñ–æ—Ç–æ"""
        if not self.products_path or not self.products_path.exists():
            return []

        # –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –ø–∞–ø–æ–∫
        products = set()
        for folder in self.products_path.iterdir():
            if folder.is_dir():
                products.add(folder.name)
        return list(products)


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
_media_manager: Optional[MediaManager] = None


def get_media_manager(products_path: Optional[str] = None) -> MediaManager:
    """–ü–æ–ª—É—á–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä MediaManager"""
    global _media_manager
    if _media_manager is None:
        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É—Ç—å –∫ unified_products
        if products_path is None:
            default_path = Path(__file__).parent.parent.parent / "unified_products"
            if default_path.exists():
                products_path = str(default_path)
        _media_manager = MediaManager(products_path)
    return _media_manager
