"""
–ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤ NL International

–ß–µ–∫–ª–∏—Å—Ç—ã –ø–æ –¥–Ω—è–º —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏.
"""
from typing import Dict, List, Optional
from datetime import datetime, timedelta
from loguru import logger


class OnboardingTasks:
    """–ß–µ–∫–ª–∏—Å—Ç—ã –∑–∞–¥–∞—á –ø–æ –¥–Ω—è–º –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞"""

    # –ó–∞–¥–∞—á–∏ –Ω–∞ –ø–µ—Ä–≤—ã–µ 7 –¥–Ω–µ–π
    TASKS_BY_DAY = {
        1: {
            "title": "–î–µ–Ω—å 1: –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ",
            "greeting": "–ü—Ä–∏–≤–µ—Ç! –°–µ–≥–æ–¥–Ω—è —Ç–≤–æ–π –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å üéâ\n–î–∞–≤–∞–π –Ω–∞—á–Ω—ë–º —Å –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–æ–≤.",
            "tasks": [
                {"id": "d1_catalog", "text": "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ NL (15 –º–∏–Ω)", "hint": "–ó–∞–≥–ª—è–Ω–∏ –Ω–∞ nl.ru –∏–ª–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ NL"},
                {"id": "d1_bestseller", "text": "–í—ã–±—Ä–∞—Ç—å 1 –ø—Ä–æ–¥—É–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—á–µ—à—å –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å", "hint": "–ù–∞—á–Ω–∏ —Å —Ç–æ–≥–æ, —á—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–±—è"},
                {"id": "d1_why", "text": "–ó–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ—é –≥–ª–∞–≤–Ω—É—é —Ü–µ–ª—å –≤ NL", "hint": "–ó–∞—á–µ–º —Ç—ã –∑–¥–µ—Å—å? –ß—Ç–æ —Ö–æ—á–µ—à—å –ø–æ–ª—É—á–∏—Ç—å?"},
            ],
            "emoji": "üå±"
        },
        2: {
            "title": "–î–µ–Ω—å 2: –ü—Ä–æ–¥—É–∫—Ç—ã",
            "greeting": "–î–µ–Ω—å 2! –í—á–µ—Ä–∞ —Ç—ã –∏–∑—É—á–∞–ª –∫–∞—Ç–∞–ª–æ–≥ ‚Äî —Å–µ–≥–æ–¥–Ω—è —É–≥–ª—É–±–ª—è–µ–º—Å—è.",
            "tasks": [
                {"id": "d2_ed", "text": "–£–∑–Ω–∞—Ç—å —á—Ç–æ —Ç–∞–∫–æ–µ Energy Diet", "hint": "–°–ø—Ä–æ—Å–∏ –º–µ–Ω—è: '–ß—Ç–æ —Ç–∞–∫–æ–µ ED?' –∏–ª–∏ '–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ Energy Diet'"},
                {"id": "d2_greenflash", "text": "–£–∑–Ω–∞—Ç—å –ø—Ä–æ –ª–∏–Ω–µ–π–∫—É Greenflash", "hint": "–ù–∞–ø–∏—à–∏: '–ß—Ç–æ —Ç–∞–∫–æ–µ Greenflash?'"},
                {"id": "d2_order", "text": "–°–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ (—Ö–æ—Ç—è –±—ã 1 –ø—Ä–æ–¥—É–∫—Ç)", "hint": "–ü–æ–ø—Ä–æ–±—É–π —Å–∞–º ‚Äî —ç—Ç–æ –≤–∞–∂–Ω–æ!"},
            ],
            "emoji": "üì¶"
        },
        3: {
            "title": "–î–µ–Ω—å 3: –ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å",
            "greeting": "–î–µ–Ω—å 3! –†–∞–∑–±–∏—Ä–∞–µ–º—Å—è –∫–∞–∫ –∑–¥–µ—Å—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç.",
            "tasks": [
                {"id": "d3_mp", "text": "–ò–∑—É—á–∏—Ç—å –º–∞—Ä–∫–µ—Ç–∏–Ω–≥-–ø–ª–∞–Ω NL (–æ—Å–Ω–æ–≤—ã)", "hint": "–°–ø—Ä–æ—Å–∏: '–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∞—Ä–∫–µ—Ç–∏–Ω–≥-–ø–ª–∞–Ω?'"},
                {"id": "d3_levels", "text": "–£–∑–Ω–∞—Ç—å –ø—Ä–æ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ (M1, M2, M3...)", "hint": "–ù–∞–ø–∏—à–∏: '–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏'"},
                {"id": "d3_income", "text": "–ü–æ—Å—á–∏—Ç–∞—Ç—å —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–¥–∞–∂ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –¥–æ—Ö–æ–¥–∞", "hint": "–°–ø—Ä–æ—Å–∏: '–ö–∞–∫ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –ø–µ—Ä–≤—ã–µ –¥–µ–Ω—å–≥–∏?'"},
            ],
            "emoji": "üíº"
        },
        4: {
            "title": "–î–µ–Ω—å 4: –°–æ—Ü—Å–µ—Ç–∏",
            "greeting": "–î–µ–Ω—å 4! –£—á–∏–º—Å—è —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö.",
            "tasks": [
                {"id": "d4_story", "text": "–ù–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é '–ø–æ—á–µ–º—É NL'", "hint": "–†–∞—Å—Å–∫–∞–∂–∏ —á–µ—Å—Ç–Ω–æ, —á—Ç–æ –ø—Ä–∏–≤–µ–ª–æ —Ç–µ–±—è —Å—é–¥–∞"},
                {"id": "d4_post", "text": "–°–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø–æ—Å—Ç –æ –ø—Ä–æ–¥—É–∫—Ç–µ –≤ —Å—Ç–æ—Ä–∏—Å", "hint": "–ù–µ –ø—Ä–æ–¥–∞–≤–∞–π ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–µ–ª–∏—Å—å –æ–ø—ã—Ç–æ–º"},
                {"id": "d4_practice", "text": "–ü–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã", "hint": "–°–ø—Ä–æ—Å–∏ –º–µ–Ω—è: '–ö–∞–∫ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è?'"},
            ],
            "emoji": "üì±"
        },
        5: {
            "title": "–î–µ–Ω—å 5: –ü–µ—Ä–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã",
            "greeting": "–î–µ–Ω—å 5! –í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å üí™",
            "tasks": [
                {"id": "d5_list", "text": "–°–æ—Å—Ç–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑ 10 –ª—é–¥–µ–π, –∫–æ–º—É –º–æ–∂–Ω–æ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å", "hint": "–ó–Ω–∞–∫–æ–º—ã–µ, –¥—Ä—É–∑—å—è, –∫–æ–ª–ª–µ–≥–∏ ‚Äî –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞"},
                {"id": "d5_msg", "text": "–ù–∞–ø–∏—Å–∞—Ç—å 3 –ª—é–¥—è–º (–Ω–µ –ø—Ä–æ–¥–∞–≤–∞—Ç—å, –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è)", "hint": "–ù–∞–ø—Ä–∏–º–µ—Ä: '–ù–∞—á–∞–ª —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è –≤ —Ç–µ–º–µ –∑–¥–æ—Ä–æ–≤–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è...'"},
                {"id": "d5_objection", "text": "–£–∑–Ω–∞—Ç—å –∫–∞–∫ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ '—ç—Ç–æ —Ä–∞–∑–≤–æ–¥/–ø–∏—Ä–∞–º–∏–¥–∞'", "hint": "–°–ø—Ä–æ—Å–∏ –º–µ–Ω—è –ø—Ä–æ —á–∞—Å—Ç—ã–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è"},
            ],
            "emoji": "üë•"
        },
        6: {
            "title": "–î–µ–Ω—å 6: –ê–Ω–∞–ª–∏–∑",
            "greeting": "–î–µ–Ω—å 6! –ü–æ–¥–≤–æ–¥–∏–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∏—Ç–æ–≥–∏.",
            "tasks": [
                {"id": "d6_review", "text": "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞ 5 –¥–Ω–µ–π", "hint": "–ß—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å? –ß—Ç–æ –±—ã–ª–æ —Å–ª–æ–∂–Ω–æ?"},
                {"id": "d6_questions", "text": "–ó–∞–¥–∞—Ç—å –º–Ω–µ –≤—Å–µ –Ω–∞–∫–æ–ø–∏–≤—à–∏–µ—Å—è –≤–æ–ø—Ä–æ—Å—ã", "hint": "–°–ø—Ä–∞—à–∏–≤–∞–π —á—Ç–æ —É–≥–æ–¥–Ω–æ ‚Äî —è –æ—Ç–≤–µ—á—É"},
                {"id": "d6_plan", "text": "–°–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é", "hint": "–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è: –∫–æ–º—É –Ω–∞–ø–∏—Å–∞—Ç—å, —á—Ç–æ –∏–∑—É—á–∏—Ç—å"},
            ],
            "emoji": "üìä"
        },
        7: {
            "title": "–î–µ–Ω—å 7: –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ",
            "greeting": "–ù–µ–¥–µ–ª—è –ø–æ–∑–∞–¥–∏! üéâ –¢—ã –º–æ–ª–æ–¥–µ—Ü, —á—Ç–æ –¥–æ—à—ë–ª —Å—é–¥–∞.",
            "tasks": [
                {"id": "d7_repeat", "text": "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (ED, Greenflash)", "hint": "–û—Å–≤–µ–∂–∏ –∑–Ω–∞–Ω–∏—è"},
                {"id": "d7_mentor", "text": "–°–≤—è–∑–∞—Ç—å—Å—è —Å –∫—É—Ä–∞—Ç–æ—Ä–æ–º/–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–æ–º", "hint": "–ï—Å–ª–∏ –µ—Å—Ç—å ‚Äî —Ä–∞—Å—Å–∫–∞–∂–∏ –æ —Å–≤–æ–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö"},
                {"id": "d7_next", "text": "–ü–æ—Å—Ç–∞–≤–∏—Ç—å —Ü–µ–ª—å –Ω–∞ –º–µ—Å—è—Ü", "hint": "–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è, –∏–∑–º–µ—Ä–∏–º–∞—è: 'X –ø—Ä–æ–¥–∞–∂' –∏–ª–∏ 'Y –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤'"},
            ],
            "emoji": "üèÜ"
        }
    }

    # –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    INACTIVITY_REMINDERS = {
        4: "–≠–π, —Ç—ã –∫—É–¥–∞ –ø—Ä–æ–ø–∞–ª? üòä –î–∞–≤–∞–π –ø—Ä–æ–¥–æ–ª–∂–∏–º ‚Äî —É —Ç–µ–±—è –µ—Å—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏!",
        12: "–ü—Ä–∏–≤–µ—Ç! –í–∏–¥–∏–º–æ, –¥–µ–ª–∞ –∑–∞—Ç—è–Ω—É–ª–∏. –ù–∞–ø–æ–º–Ω—é ‚Äî –º—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å –Ω–∞...",
        24: "–î–µ–Ω—å –ø—Ä–æ—à—ë–ª... –ú–æ–∂–µ—Ç, —É–¥–µ–ª–∏—à—å 10 –º–∏–Ω—É—Ç? –Ø —Ç—É—Ç, –µ—Å–ª–∏ —á—Ç–æ üí™",
        48: "–î–≤–∞ –¥–Ω—è —Ç–∏—à–∏–Ω—ã ü§î –í—Å—ë –æ–∫? –ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ‚Äî –Ω–∞–ø–∏—à–∏, —Ä–∞–∑–±–µ—Ä—ë–º—Å—è.",
        168: "–ù–µ–¥–µ–ª—è –±–µ–∑ –Ω–æ–≤–æ—Å—Ç–µ–π. –ï—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–ª ‚Äî –Ω–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ. –ù–æ –µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞—Å—Ç—Ä—è–ª ‚Äî —è –ø–æ–º–æ–≥—É!",
    }

    @classmethod
    def get_day_tasks(cls, day: int) -> Optional[Dict]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å

        Args:
            day: –ù–æ–º–µ—Ä –¥–Ω—è (1-7)

        Returns:
            Dict —Å –∑–∞–¥–∞—á–∞–º–∏ –∏–ª–∏ None
        """
        return cls.TASKS_BY_DAY.get(day)

    @classmethod
    def format_tasks_message(cls, day: int, completed_tasks: List[str] = None) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–¥–∞—á–∞–º–∏ –Ω–∞ –¥–µ–Ω—å

        Args:
            day: –ù–æ–º–µ—Ä –¥–Ω—è
            completed_tasks: –°–ø–∏—Å–æ–∫ ID –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á

        Returns:
            –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        """
        completed_tasks = completed_tasks or []
        day_info = cls.get_day_tasks(day)

        if not day_info:
            return "–ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –¢—ã –ø—Ä–æ—à—ë–ª –±–∞–∑–æ–≤—ã–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ üéâ\n–¢–µ–ø–µ—Ä—å –º–æ–∂–µ–º —É–≥–ª—É–±–∏—Ç—å—Å—è –≤ –ª—é–±—É—é —Ç–µ–º—É."

        emoji = day_info["emoji"]
        message = f"{emoji} <b>{day_info['title']}</b>\n\n"
        message += f"{day_info['greeting']}\n\n"
        message += "<b>–¢–≤–æ–∏ –∑–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:</b>\n\n"

        for i, task in enumerate(day_info["tasks"], 1):
            is_done = task["id"] in completed_tasks
            checkbox = "‚úÖ" if is_done else "‚¨ú"
            strikethrough = "<s>" if is_done else ""
            strikethrough_end = "</s>" if is_done else ""

            message += f"{checkbox} {strikethrough}{task['text']}{strikethrough_end}\n"
            if not is_done and task.get("hint"):
                message += f"   <i>üí° {task['hint']}</i>\n"
            message += "\n"

        completed_count = sum(1 for t in day_info["tasks"] if t["id"] in completed_tasks)
        total_count = len(day_info["tasks"])

        message += f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        message += f"–ü—Ä–æ–≥—Ä–µ—Å—Å: {completed_count}/{total_count}"

        if completed_count == total_count:
            message += " üéâ –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!"

        return message

    @classmethod
    def get_inactivity_reminder(cls, hours_inactive: int) -> Optional[str]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Args:
            hours_inactive: –ß–∞—Å–æ–≤ –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

        Returns:
            –¢–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–ª–∏ None
        """
        for threshold, message in sorted(cls.INACTIVITY_REMINDERS.items()):
            if hours_inactive >= threshold:
                return message
        return None


def get_task_for_day(day: int) -> Optional[Dict]:
    """–û–±—ë—Ä—Ç–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–¥–∞—á –Ω–∞ –¥–µ–Ω—å"""
    return OnboardingTasks.get_day_tasks(day)


async def get_user_progress(telegram_id: int) -> Dict:
    """
    –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥—É

    Args:
        telegram_id: Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    Returns:
        Dict —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
    """
    from curator_bot.onboarding.onboarding_service import OnboardingService
    return await OnboardingService.get_user_progress_dict(telegram_id)


async def mark_task_completed(telegram_id: int, task_id: str) -> bool:
    """
    –û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é

    Args:
        telegram_id: Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        task_id: ID –∑–∞–¥–∞—á–∏

    Returns:
        True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
    """
    from curator_bot.onboarding.onboarding_service import OnboardingService
    result = await OnboardingService.mark_task_completed(telegram_id, task_id)
    if result:
        logger.info(f"Task {task_id} marked as completed for user {telegram_id}")
    return result
